#!/usr/bin/env python
#
# Copyright (c) 2014 NSONE, Inc.
#
# License under The MIT License (MIT). See LICENSE in project root.
#

"""
usage: nsone [-h] [-v ...] [-s <server>] [-k <key>] [-c <name>=<value>]
             [-f <format>] [--version] <command> [<args>...]

options:
   -v                     Increase verbosity level. Can be used more than once.
   -c <name=value>        Define config key "name" to be "value"
   -k, --key <key>        Use the specified API Key
   -s, --server <server>  Use the specified server endpoint
   -f, --format <format>  Output format: 'text' or 'json'
   -h, --help             Get help!

Commands:
"""

import sys
from docopt import docopt
from nsone import NSONE
from nsone.config import ConfigException
from nsonecli.version import VERSION
from nsonecli.commands.base import BaseCommand, CommandException
import nsonecli.commands


# gather commands
cmdList = {}
for sym, ins in nsonecli.commands.__dict__.items():
    if isinstance(ins, BaseCommand):
        cmdList[sym] = ins

# add to doc help
for cname, cmd in cmdList.items():
    __doc__ += '    %s     %s\n' % (cname, cmd.SHORT_HELP)

__doc__ += "\nSee 'nsone help <command>' for more information on a " \
           "specific command."


if __name__ == '__main__':
    args = docopt(__doc__,
                  version='nsone CLI version %s' % VERSION,
                  options_first=True)
    # print('global arguments:')
    # print(args)
    # print('command arguments:')

    try:
        nsone = NSONE()
    except ConfigException as e:
        print(e.message)
        sys.exit(1)
    except IOError as e:
        print('No config file was found. Either specify an API key on the '
              'command line, or create %s' % NSONE.DEFAULT_CONFIG_FILE)
        sys.exit(1)

    # do config overrides in nsone based on cmd args
    if args['--format']:
        nsone.config['cli']['output_format'] = args['--format']

    # do defaults
    if 'output_format' not in nsone.config.get('cli', {}):
        nsone.config['cli']['output_format'] = 'text'

    BaseCommand.nsone = nsone

    cmd = args['<command>']
    cmdArgs = args['<args>']
    subArgv = [cmd] + cmdArgs
    # print "%s | %s | %s" % (cmd, cmdArgs, subArgv)
    if cmd in cmdList.keys():
        svc = cmdList[cmd]
        subArgs = docopt(svc.__doc__, argv=subArgv)
        try:
            svc.run(subArgs)
        except CommandException as e:
            print(e.message)
            sys.exit(1)
    elif cmd == 'help':
        print(__doc__)
    else:
        exit("%r is not a command. See 'nsone help'." % cmd)

